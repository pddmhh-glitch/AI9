<analysis>**original_problem_statement:**
The user has provided a final, comprehensive MASTER FIX PROMPT to perform a surgical refactor on the entire application. The goal is to fix, remove, consolidate, and correctly wire up existing functionality without rebuilding or adding new features.

**PRODUCT REQUIREMENTS (NON-NEGOTIABLE GOALS):**
1.  **Unified Telegram System:** Consolidate to a single multi-bot architecture with per-bot permissions and per-event notification toggles. Some bots are designated payment reviewers, while others are for notifications only. All legacy Telegram systems must be deleted.
2.  **Telegram-First Approvals:** All payment proofs (wallet top-ups, game loads) must be reviewed and approved/rejected via Telegram by a reviewer bot.
3.  **Admin UI for Auditing:** The Admin UI must still provide a view of all orders and allow for review (approve/reject), but this action must go through the same centralized approval service as the Telegram actions, not bypass it.
4.  **Edit Amount Feature:** Telegram reviewers must have a one-time option to edit the payment amount before approving.
5.  **Strict Order Type Logic:**
    *   **Chatwoot Deposits:** Create  orders only. One deposit maps to one game load, and approval must not credit the user's wallet.
    *   **Wallet Top-up & Withdrawal:** These actions are restricted to the client-side portal, create  or  orders, and require Telegram review. Wallet top-up approval credits the user's wallet.
6.  **No DB Storage for Proofs:** Payment proof images must be forwarded directly to Telegram and are NOT to be stored in the database (no URLs, no base64).
7.  **Database & Code Cleanup:** The entire application must run on PostgreSQL () only. All remnants of MongoDB (config, packages, code) must be removed.
8.  **Frontend Alignment:** The frontend (Admin and Client portals) must be fixed to align with the new backend architecture, removing broken pages, disabling demo/mock modes, and wiring up actions to the correct, non-legacy endpoints.

**User's preferred language**: English

**what currently exists?**
The application is a full-stack gaming platform with a React frontend and a FastAPI backend using a PostgreSQL database. In this session, the agent has performed several refactoring steps based on a series of user prompts. A multi-bot Telegram notification system with a webhook for interactive buttons has been established. Most recently, the agent began a major surgical refactor based on the user's MASTER FIX PROMPT. A new centralized  has been created, and the agent has started modifying the Telegram routes to use this service, while also cleaning up legacy code and database schemas. The application is currently in a transitional, non-functional state due to the in-progress refactor.

**Last working item**:
    - Last item agent was working: The agent was refactoring the Telegram callback handlers in  to use the newly created centralized . It successfully replaced the logic for approving wallet loads and was in the process of cleaning up the remaining legacy rejection logic within the same function ().
    - Status: IN PROGRESS
    - Agent Testing Done: N
    - Which testing method agent to use? both
    - User Testing Done: N

**All Pending/In progress Issue list**:
  - Issue 1: Complete the FINAL MASTER FIX PROMPT Surgical Refactor (P0)

  Issues Detail:
  - Issue 1: 
     - Attempted fixes:
        - Created a centralized approval service at .
        - Started refactoring  to use the new service.
        - Removed legacy  table from  and broken imports from .
        - Implemented backend logic for the Edit Amount feature in  and updated the database schema.
        - Completed a significant portion of the frontend fixes, including disabling , centralizing API calls, and making several admin pages read-only or removing legacy controls.
     - Next debug checklist:
        1. Finish refactoring  by updating the  to also use the .
        2. Delete the legacy  endpoint entirely from .
        3. Ensure the Admin UI's approval buttons (e.g., in ) are re-wired to call an endpoint that uses the new , rather than a legacy one.
        4. Verify that the Edit Amount flow is fully functional from Telegram callback to database update.
        5. Test the complete end-to-end user flows defined in the user's FINAL ACCEPTANCE TESTS.
     - Why fix this issue and what will be achieved with the fix? This is the user's primary and final request to stabilize the entire application, create a single source of truth for business logic, enhance security, and remove all technical debt and duplicate code.
     - Status:  IN PROGRESS
     - Is recurring issue? N
     - Should Test frontend/backend/both after fix? both
     - Blocked on other issue: None

**In progress Task List**:
  - Task 1: Unify All Approval Logic Under  (P0)
     - Where to resume: The agent needs to refactor the  function in  and any admin approval endpoints to use the new , ensuring all approval/rejection logic passes through this single service.
     - What will be achieved with this? A secure, idempotent, and centralized system for all payment and order approvals, eliminating fragmented and insecure logic.
     - Status:  IN PROGRESS
     - Should Test frontend/backend/both after fix? backend
     - Blocked on something: None

**Upcoming and Future Tasks**
Upcoming Tasks:
*   **(P0) Wire Admin UI to New Approval Service**: Update the admin panel's order review pages to use the new centralized  for approve/reject actions, instead of legacy endpoints. (Files: )
*   **(P1) Enforce Chatwoot Idempotency**: Implement a unique index on the  table using a key from Chatwoot ( + ) to prevent duplicate game load orders.
*   **(P2) Final Backend Cleanup**: Remove  and  from . Search the codebase for any final, missed references to MongoDB or legacy Telegram functions and delete them.
*   **(P3) Comprehensive E2E Testing**: Execute all scenarios from the FINAL ACCEPTANCE TESTS section of the user's prompt to validate the entire refactor.

Future Tasks:
*   None. The current goal is to finalize the requested refactor.

**Completed work in this session**
- **Project Setup**: Unzipped artifacts, configured PostgreSQL, installed all dependencies, and created an initial admin user.
- **Initial Notification System**: Successfully set up and tested a multi-bot Telegram notification system, including fixing bugs with missing event triggers and making interactive buttons functional via a webhook.
- **Feature Expansion**: Added new notification events for user registration, referrals, and promo code redemption.
- **Surgical Refactor (Backend)**:
  - Created a unified .
  - Removed all  variables from .
  - Removed legacy  table from .
  - Implemented the Edit Amount feature, including database schema changes and callback logic in .
  - Began refactoring  to use the new .
  - Removed broken imports and legacy endpoints from  and .
- **Surgical Refactor (Frontend)**:
  - Disabled  in  and .
  - Centralized backend URL usage into .
  - Fixed  by removing the Simulate Payment button.
  - Removed legacy Telegram controls from .
  - Converted  to a read-only page.
  - Added a Request Withdrawal feature to the  page.
  - Replaced direct  usage with the new  helper across multiple files.

**Earlier issues found/mentioned but not fixed**
   - Issue 1: Admin UI Navigation Crash
     - Description: A previous summary noted that navigating to  caused a browser crash. While the functionality of the page itself was addressed, the root navigation bug was not.
     - Debug checklist:
        1. Check browser console logs when navigating within the  area.
        2. Review React component lifecycle and data fetching in  and related pages for potential infinite loops.
     - Why to solve this issue and what will be achieved with this? This will improve admin usability, preventing reliance on direct URL pasting.
     - Should Test frontend/backend/both after fix: frontend
     - Is recurring issue? Y

**Known issue recurrence from previous fork**
  - None.

**Code Architecture**


**Key Technical Concepts**
*   **Backend**: FastAPI, PostgreSQL ().
*   **Frontend**: React.js, Tailwind CSS.
*   **Architecture**:
    *   **Event-Driven Notifications**: A central  dispatches events to subscribed Telegram bots.
    *   **Centralized Approval Service**: A single  handles all business logic for approvals/rejections, ensuring consistency and security.
*   **Security**: Moving from insecure webhook URLs (with bot tokens) to a secure, single webhook endpoint.

**key DB schema**
  - **orders**: {{ ..., amount_adjusted (bool), adjusted_by (uuid), adjusted_at (timestamp) }} -> Columns added for the Edit Amount feature.
  - **telegram_bots**: {{ id, name, bot_token, chat_id, is_active, can_approve_payments, can_receive_notifications }}
  - **telegram_bot_event_permissions**: {{ telegram_bot_id, event_type, enabled }}
  - **telegram_config**: **REMOVED** from database schema.

**changes in tech stack**
  - **MongoDB completely removed**: The application is now purely PostgreSQL. Packages like  and  should be removed from .

**All files of reference**
*   **/app/backend/api/v1/core/approval_service.py**: **Newly Created**. The single source of truth for order approval logic.
*   **/app/backend/api/v1/routes/telegram_routes.py**: **Heavily Modified**. Updated to use the approval service and handle the Edit Amount feature.
*   **/app/backend/api/v1/core/database.py**: **Modified**. Legacy  table removed, and new columns added to the  table.
*   **/app/frontend/src/utils/api.js**: **Newly Created**. Centralizes the backend URL for all frontend API calls.
*   **/app/frontend/src/pages/portal/PortalWithdrawals.js**: **Rewritten** to add a form for users to request withdrawals.
*   **/app/frontend/src/pages/admin/system/AdminWalletLoads.js**: **Rewritten** to be a read-only status page, as approvals now happen in Telegram.
*   **/app/frontend/src/pages/admin/AdminOperationsPanel.js**: **Modified** to remove the legacy single-bot Telegram configuration UI.
*   **/app/frontend/src/pages/admin/AdminTelegramSetup.js**: **Deleted**.

**Areas that need refactoring**:
*   The  file still contains the legacy  endpoint, which must be deleted.
*   The frontend admin pages for reviewing orders need to be connected to the new  instead of any remaining legacy endpoints.

**key api endpoints**
*   : (POST) **Secure webhook** for all Telegram bot callbacks.
*   : (POST) Client submits a wallet top-up request.
*   : (POST) Client submits a withdrawal request.
*   : (CRUD) Endpoints for managing the multi-bot system.
*   : (POST) **LEGACY endpoint that must be deleted.**

**Critical Info for New Agent**
*   **Follow the Master Prompt**: Your primary directive is to complete all remaining tasks outlined in the user's FINAL MASTER FIX PROMPT. Do not deviate or add new features.
*   **Refactor is In-Progress**: The application is in a non-functional state. Your first task is to finish the ongoing refactoring to restore stability.
*   **Centralized Logic is Key**: All new and modified logic must route through  for sending messages and  for handling approvals/rejections. Do not add logic directly into the route handlers.
*   **No DB for Images**: Remember that payment proof images are *never* saved to the database. They are forwarded directly to Telegram.
*   **DEMO_MODE is OFF**: The frontend is now running in live mode. All protected API calls will require a valid auth token.

**documents and test reports created in this job**
  - None.

**Last 10 User Messages and any pending HUMAN messages** 
 - All of the last user messages are detailed, surgical prompts instructing the agent on how to refactor the entire application. The final and most important one is the FINAL MASTER FIX PROMPT, which consolidates all previous instructions and serves as the main goal for this and subsequent sessions. There are no pending conversational messages.

**Project Health Check:**
*   **Broken**: The application is in a broken, transitional state due to the large-scale, in-progress refactor. Backend routes are inconsistent, and the frontend is partially aligned with the new backend.
*   **Mocked**:  was active but has now been disabled. No other major mocking is expected.

**3rd Party Integrations**
*   **PostgreSQL**: Primary application database.
*   **Telegram Bot API**: Used for the notification and payment review system.

**Testing status**
  - Testing agent used after significant changes: NO
  - Troubleshoot agent used after agent stuck in loop: NO
  - Test files created: None
  - Known regressions: The entire application is in a regressed state until the refactor is complete.

**Credentials to test flow:**
*   **Admin Login**:  / 
*   **Telegram Bot Token**: 
*   **Test User Chat ID**: 

**What agent forgot to execute**
The agent has not forgotten tasks but is in the middle of a very large one. The following key items from the user's master prompt are started but not yet complete or are pending:
*   Fully removing all legacy Telegram endpoints and code (e.g., ).
*   Wiring up the Admin UI's approval buttons to the new centralized .
*   Implementing idempotency for Chatwoot  orders.
*   A full end-to-end test of all flows described in the FINAL ACCEPTANCE TESTS.</analysis>
